@page "/vehiculo"
@using BlazorVehicleTest.Data
@inject BlazorVehicleTest.Metodos.MetodoVehiculo MetodoVehiculo

<h3>Insertar Vehículo</h3>

<EditForm Model="@vehiculo" OnValidSubmit="InsertarVehiculo">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label for="chasisNo">Chasis No</label>
        <InputText id="chasisNo" class="form-control" @bind-Value="vehiculo.Chasis_No" />
    </div>

    <div class="form-group">
        <label for="ano">Año</label>
        <InputNumber id="ano" class="form-control" @bind-Value="vehiculo.Ano" />
    </div>

    <div class="form-group">
        <label for="color">Color</label>
        <InputText id="color" class="form-control" @bind-Value="vehiculo.Color" />
    </div>
<div class="form-group">
    <label for="marca">Marca</label>
    <InputSelect id="marca" class="form-control" @bind-Value="vehiculo.Marca_id" @onchange="CargarModelos">
        <option value="">Seleccione una marca</option>
        @foreach (var marca in marcas)
        {
            <option value="@marca.Marca_id">@marca.Marca_descripcion</option>
        }
    </InputSelect>
</div>

<!-- Mostrar el ID de la marca seleccionada -->
<div class="form-group">
    <label>Marca seleccionada ID:</label>
    <p>@vehiculo.Marca_id</p>
</div>

<div class="form-group">
    <label for="modelo">Modelo</label>
    @if (modelos.Count == 0)
    {
        <p>No hay modelos disponibles para esta marca</p>
    }
    else
    {
        <InputSelect id="modelo" class="form-control" @bind-Value="vehiculo.Modelo_id">
            <option value="">Seleccione un modelo</option>
            @foreach (var modelo in modelos)
            {
                <option value="@modelo.Modelo_id">@modelo.Modelo_descripcion</option>
            }
        </InputSelect>
    }
</div>


    <div class="form-group">
        <label for="placa">Placa</label>
        <InputText id="placa" class="form-control" @bind-Value="vehiculo.Placa" />
    </div>

    <button type="submit" class="btn btn-primary">Insertar Vehículo</button>
</EditForm>

@code {
    private tb_vehiculo vehiculo = new tb_vehiculo();
    private List<tb_marca> marcas = new List<tb_marca>();
    private List<tb_modelo> modelos = new List<tb_modelo>();

    protected override async Task OnInitializedAsync()
    {
        // Cargar las marcas al inicializar la página
        marcas = MetodoVehiculo.ObtenerMarcas();
    }

private async Task CargarModelos(ChangeEventArgs e)
{
    int marcaId = int.Parse(e.Value.ToString());
    vehiculo.Marca_id = marcaId;
    
    if (marcaId > 0 && marcas.Any(m => m.Marca_id == marcaId))
    {
        modelos =  MetodoVehiculo.ObtenerModelo(marcaId);
    }
    else
    {
        modelos.Clear();
    }

    StateHasChanged();
}



    private void InsertarVehiculo()
    {
        vehiculo.Fecha_Registro = DateTime.Now; // Asignar la fecha actual
        MetodoVehiculo.Insertar(vehiculo);
        // Resetear el formulario después de insertar
        vehiculo = new tb_vehiculo();
        modelos.Clear();
    }
}
